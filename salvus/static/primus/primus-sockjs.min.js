(function UMDish(name,context,definition){context[name]=definition.call(context);if(typeof module!=="undefined"&&module.exports){module.exports=context[name]}else if(typeof define=="function"&&define.amd){define(function reference(){return context[name]})}})("Primus",this,function Primus(){"use strict";function EE(fn,context,once){this.fn=fn;this.context=context;this.once=once||false}function EventEmitter(){}EventEmitter.prototype._events=undefined;EventEmitter.prototype.listeners=function listeners(event){if(!this._events||!this._events[event])return[];for(var i=0,l=this._events[event].length,ee=[];i<l;i++){ee.push(this._events[event][i].fn)}return ee};EventEmitter.prototype.emit=function emit(event,a1,a2,a3,a4,a5){if(!this._events||!this._events[event])return false;var listeners=this._events[event],length=listeners.length,len=arguments.length,ee=listeners[0],args,i,j;if(1===length){if(ee.once)this.removeListener(event,ee.fn,true);switch(len){case 1:return ee.fn.call(ee.context),true;case 2:return ee.fn.call(ee.context,a1),true;case 3:return ee.fn.call(ee.context,a1,a2),true;case 4:return ee.fn.call(ee.context,a1,a2,a3),true;case 5:return ee.fn.call(ee.context,a1,a2,a3,a4),true;case 6:return ee.fn.call(ee.context,a1,a2,a3,a4,a5),true}for(i=1,args=new Array(len-1);i<len;i++){args[i-1]=arguments[i]}ee.fn.apply(ee.context,args)}else{for(i=0;i<length;i++){if(listeners[i].once)this.removeListener(event,listeners[i].fn,true);switch(len){case 1:listeners[i].fn.call(listeners[i].context);break;case 2:listeners[i].fn.call(listeners[i].context,a1);break;case 3:listeners[i].fn.call(listeners[i].context,a1,a2);break;default:if(!args)for(j=1,args=new Array(len-1);j<len;j++){args[j-1]=arguments[j]}listeners[i].fn.apply(listeners[i].context,args)}}}return true};EventEmitter.prototype.on=function on(event,fn,context){if(!this._events)this._events={};if(!this._events[event])this._events[event]=[];this._events[event].push(new EE(fn,context||this));return this};EventEmitter.prototype.once=function once(event,fn,context){if(!this._events)this._events={};if(!this._events[event])this._events[event]=[];this._events[event].push(new EE(fn,context||this,true));return this};EventEmitter.prototype.removeListener=function removeListener(event,fn,once){if(!this._events||!this._events[event])return this;var listeners=this._events[event],events=[];if(fn)for(var i=0,length=listeners.length;i<length;i++){if(listeners[i].fn!==fn&&listeners[i].once!==once){events.push(listeners[i])}}if(events.length)this._events[event]=events;else this._events[event]=null;return this};EventEmitter.prototype.removeAllListeners=function removeAllListeners(event){if(!this._events)return this;if(event)this._events[event]=null;else this._events={};return this};EventEmitter.prototype.off=EventEmitter.prototype.removeListener;EventEmitter.prototype.addListener=EventEmitter.prototype.on;EventEmitter.prototype.setMaxListeners=function setMaxListeners(){return this};function context(self,method){if(self instanceof Primus)return;var failure=new Error("Primus#"+method+"'s context should called with a Primus instance");if("function"!==typeof self.listeners||!self.listeners("error").length){throw failure}self.emit("error",failure)}var defaultUrl;try{if(location.origin){defaultUrl=location.origin}else{defaultUrl=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}}catch(e){defaultUrl="http://127.0.0.1"}function Primus(url,options){if(!(this instanceof Primus))return new Primus(url,options);if("function"!==typeof this.client){var message="The client library has not been compiled correctly, "+"see https://github.com/primus/primus#client-library for more details";return this.critical(new Error(message))}if("object"===typeof url){options=url;url=options.url||options.uri||defaultUrl}else{options=options||{}}var primus=this;options.queueSize="queueSize"in options?options.queueSize:Infinity;options.timeout="timeout"in options?options.timeout:1e4;options.reconnect="reconnect"in options?options.reconnect:{};options.ping="ping"in options?options.ping:25e3;options.pong="pong"in options?options.pong:1e4;options.strategy="strategy"in options?options.strategy:[];options.transport="transport"in options?options.transport:{};primus.buffer=[];primus.writable=true;primus.readable=true;primus.url=primus.parse(url||defaultUrl);primus.readyState=Primus.CLOSED;primus.options=options;primus.timers={};primus.attempt=null;primus.socket=null;primus.latency=0;primus.stamps=0;primus.disconnect=false;primus.transport=options.transport;primus.transformers={outgoing:[],incoming:[]};if("string"===typeof options.strategy){options.strategy=options.strategy.split(/\s?\,\s?/g)}if(false===options.strategy){options.strategy=[]}else if(!options.strategy.length){options.strategy.push("disconnect","online");if(!this.authorization)options.strategy.push("timeout")}options.strategy=options.strategy.join(",").toLowerCase();if(!Stream)EventEmitter.call(primus);if("websockets"in options){primus.AVOID_WEBSOCKETS=!options.websockets}if("network"in options){primus.NETWORK_EVENTS=options.network}if(!options.manual)primus.timers.open=setTimeout(function open(){primus.clearTimeout("open").open()},0);primus.initialise(options)}Primus.require=function requires(name){if("function"!==typeof require)return undefined;return!("function"===typeof define&&define.amd)?require(name):undefined};var Stream,parse;try{Primus.Stream=Stream=Primus.require("stream");parse=Primus.require("url").parse;Primus.require("util").inherits(Primus,Stream)}catch(e){Primus.Stream=EventEmitter;Primus.prototype=new EventEmitter;parse=function parse(url){var a=document.createElement("a"),data={},key;a.href=url;for(key in a){if("string"===typeof a[key]||"number"===typeof a[key]){data[key]=a[key]}}if(!data.port){var splits=(data.href||"").split("/");if(splits.length>2){var host=splits[2],atSignIndex=host.lastIndexOf("@");if(~atSignIndex)host=host.slice(atSignIndex+1);splits=host.split(":");if(splits.length===2)data.port=splits[1]}}if(":"===data.protocol){data.protocol=data.href.substr(0,data.href.indexOf(":")+1)}if("0"===data.port)data.port="";if(~data.href.indexOf("@")&&!data.auth){var start=data.protocol.length+2;data.auth=data.href.slice(start,data.href.indexOf(data.pathname,start)).split("@")[0]}return data}}Primus.OPENING=1;Primus.CLOSED=2;Primus.OPEN=3;Primus.prototype.AVOID_WEBSOCKETS=false;Primus.prototype.NETWORK_EVENTS=false;Primus.prototype.online=true;try{if(Primus.prototype.NETWORK_EVENTS="onLine"in navigator&&(window.addEventListener||document.body.attachEvent)){if(!navigator.onLine){Primus.prototype.online=false}}}catch(e){}Primus.prototype.ark={};Primus.prototype.plugin=function plugin(name){context(this,"plugin");if(name)return this.ark[name];var plugins={};for(name in this.ark){plugins[name]=this.ark[name]}return plugins};Primus.prototype.reserved=function reserved(evt){return/^(incoming|outgoing)::/.test(evt)||evt in this.reserved.events};Primus.prototype.reserved.events={readyStateChange:1,reconnecting:1,reconnected:1,reconnect:1,offline:1,timeout:1,online:1,error:1,close:1,open:1,data:1,end:1};Primus.prototype.initialise=function initialise(options){var primus=this,start;primus.on("outgoing::open",function opening(){var readyState=primus.readyState;primus.readyState=Primus.OPENING;if(readyState!==primus.readyState){primus.emit("readyStateChange","opening")}start=+new Date});primus.on("incoming::open",function opened(){var readyState=primus.readyState,reconnect=primus.attempt;if(primus.attempt)primus.attempt=null;primus.writable=true;primus.readable=true;if(!primus.online){primus.online=true;primus.emit("online")}primus.readyState=Primus.OPEN;if(readyState!==primus.readyState){primus.emit("readyStateChange","open")}primus.latency=+new Date-start;primus.emit("open");if(reconnect)primus.emit("reconnected");primus.clearTimeout("ping","pong").heartbeat();if(primus.buffer.length){var data=primus.buffer.slice(),length=data.length,i=0;primus.buffer.length=0;for(;i<length;i++){primus._write(data[i])}}});primus.on("incoming::pong",function pong(time){primus.online=true;primus.clearTimeout("pong").heartbeat();primus.latency=+new Date-time});primus.on("incoming::error",function error(e){var connect=primus.timers.connect,err=e;if(primus.attempt)return primus.reconnect();if("string"===typeof e){err=new Error(e)}else if(!(e instanceof Error)&&"object"===typeof e){err=new Error(e.message||e.reason);for(var key in e){if(e.hasOwnProperty(key))err[key]=e[key]}}if(primus.listeners("error").length)primus.emit("error",err);if(connect){if(~primus.options.strategy.indexOf("timeout"))primus.reconnect();else primus.end()}});primus.on("incoming::data",function message(raw){primus.decoder(raw,function decoding(err,data){if(err)return primus.listeners("error").length&&primus.emit("error",err);if(primus.protocol(data))return;primus.transforms(primus,primus,"incoming",data,raw)})});primus.on("incoming::end",function end(){var readyState=primus.readyState;if(primus.disconnect){primus.disconnect=false;return primus.end()}primus.readyState=Primus.CLOSED;if(readyState!==primus.readyState){primus.emit("readyStateChange","end")}if(primus.timers.connect)primus.end();if(readyState!==Primus.OPEN)return;this.writable=false;this.readable=false;for(var timeout in this.timers){this.clearTimeout(timeout)}primus.emit("close");if(~primus.options.strategy.indexOf("disconnect")){return primus.reconnect()}primus.emit("outgoing::end");primus.emit("end")});primus.client();for(var plugin in primus.ark){primus.ark[plugin].call(primus,primus,options)}if(!primus.NETWORK_EVENTS)return primus;function offline(){if(!primus.online)return;primus.online=false;primus.emit("offline");primus.end()}function online(){if(primus.online)return;primus.online=true;primus.emit("online");if(~primus.options.strategy.indexOf("online"))primus.reconnect()}if(window.addEventListener){window.addEventListener("offline",offline,false);window.addEventListener("online",online,false)}else if(document.body.attachEvent){document.body.attachEvent("onoffline",offline);document.body.attachEvent("ononline",online)}return primus};Primus.prototype.protocol=function protocol(msg){if("string"!==typeof msg||msg.indexOf("primus::")!==0)return false;var last=msg.indexOf(":",8),value=msg.slice(last+2);switch(msg.slice(8,last)){case"pong":this.emit("incoming::pong",value);break;case"server":if("close"===value){this.disconnect=true}break;case"id":this.emit("incoming::id",value);break;default:return false}return true};Primus.prototype.transforms=function transforms(primus,connection,type,data,raw){var packet={data:data},fns=primus.transformers[type];(function transform(index,done){var transformer=fns[index++];if(!transformer)return done();if(1===transformer.length){if(false===transformer.call(connection,packet)){return}return transform(index,done)}transformer.call(connection,packet,function finished(err,arg){if(err)return connection.emit("error",err);if(false===arg)return;transform(index,done)})})(0,function done(){if("incoming"===type)return connection.emit("data",packet.data,raw);connection._write(packet.data)});return this};Primus.prototype.id=function id(fn){if(this.socket&&this.socket.id)return fn(this.socket.id);this._write("primus::id::");return this.once("incoming::id",fn)};Primus.prototype.open=function open(){context(this,"open");if(!this.attempt&&this.options.timeout)this.timeout();this.emit("outgoing::open");return this};Primus.prototype.write=function write(data){context(this,"write");this.transforms(this,this,"outgoing",data);return true};Primus.prototype._write=function write(data){var primus=this;if(Primus.OPEN!==primus.readyState){if(this.buffer.length===this.options.queueSize){this.buffer.splice(0,1)}this.buffer.push(data);return false}primus.encoder(data,function encoded(err,packet){if(err)return primus.listeners("error").length&&primus.emit("error",err);primus.emit("outgoing::data",packet)});return true};Primus.prototype.heartbeat=function heartbeat(){var primus=this;if(!primus.options.ping)return primus;function pong(){primus.clearTimeout("pong");if(!primus.online)return;primus.online=false;primus.emit("offline");primus.emit("incoming::end")}function ping(){var value=+new Date;primus.clearTimeout("ping")._write("primus::ping::"+value);primus.emit("outgoing::ping",value);primus.timers.pong=setTimeout(pong,primus.options.pong)}primus.timers.ping=setTimeout(ping,primus.options.ping);return this};Primus.prototype.timeout=function timeout(){var primus=this;function remove(){primus.removeListener("error",remove).removeListener("open",remove).removeListener("end",remove).clearTimeout("connect")}primus.timers.connect=setTimeout(function expired(){remove();if(primus.readyState===Primus.OPEN||primus.attempt)return;primus.emit("timeout");if(~primus.options.strategy.indexOf("timeout"))primus.reconnect();else primus.end()},primus.options.timeout);return primus.on("error",remove).on("open",remove).on("end",remove)};Primus.prototype.clearTimeout=function clear(){for(var args=arguments,i=0,l=args.length;i<l;i++){if(this.timers[args[i]])clearTimeout(this.timers[args[i]]);delete this.timers[args[i]]}return this};Primus.prototype.backoff=function backoff(callback,opts){opts=opts||{};var primus=this;if(opts.backoff)return primus;opts.maxDelay="maxDelay"in opts?opts.maxDelay:Infinity;opts.minDelay="minDelay"in opts?opts.minDelay:500;opts.retries="retries"in opts?opts.retries:10;opts.attempt=(+opts.attempt||0)+1;opts.factor="factor"in opts?opts.factor:2;if(opts.attempt>opts.retries){callback(new Error("Unable to retry"),opts);return primus}opts.backoff=true;opts.timeout=opts.attempt!==1?Math.min(Math.round((Math.random()+1)*opts.minDelay*Math.pow(opts.factor,opts.attempt)),opts.maxDelay):opts.minDelay;primus.timers.reconnect=setTimeout(function delay(){opts.backoff=false;primus.clearTimeout("reconnect");callback(undefined,opts)},opts.timeout);primus.emit("reconnecting",opts);return primus};Primus.prototype.reconnect=function reconnect(){var primus=this;primus.attempt=primus.attempt||primus.clone(primus.options.reconnect);primus.backoff(function attempt(fail,backoff){if(fail){primus.attempt=null;return primus.emit("end")}primus.emit("reconnect",backoff);primus.emit("outgoing::reconnect")},primus.attempt);return primus};Primus.prototype.end=function end(data){context(this,"end");if(this.readyState===Primus.CLOSED&&!this.timers.connect){if(this.timers.reconnect){this.clearTimeout("reconnect");this.attempt=null;this.emit("end")}return this}if(data!==undefined)this.write(data);this.writable=false;this.readable=false;var readyState=this.readyState;this.readyState=Primus.CLOSED;if(readyState!==this.readyState){this.emit("readyStateChange","end")}for(var timeout in this.timers){this.clearTimeout(timeout)}this.emit("outgoing::end");this.emit("close");this.emit("end");return this};Primus.prototype.clone=function clone(obj){return this.merge({},obj)};Primus.prototype.merge=function merge(target){var args=Array.prototype.slice.call(arguments,1);for(var i=0,l=args.length,key,obj;i<l;i++){obj=args[i];for(key in obj){if(obj.hasOwnProperty(key))target[key]=obj[key]}}return target};Primus.prototype.parse=parse;Primus.prototype.querystring=function querystring(query){var parser=/([^=?&]+)=([^&]*)/g,result={},part;for(;part=parser.exec(query);result[decodeURIComponent(part[1])]=decodeURIComponent(part[2]));return result};Primus.prototype.querystringify=function querystringify(obj){var pairs=[];for(var key in obj){if(obj.hasOwnProperty(key)){pairs.push(encodeURIComponent(key)+"="+encodeURIComponent(obj[key]))}}return pairs.join("&")};Primus.prototype.uri=function uri(options){var url=this.url,server=[],qsa=false;if(options.query)qsa=true;options=options||{};options.protocol="protocol"in options?options.protocol:"http";options.query=url.search&&"query"in options?url.search.charAt(0)==="?"?url.search.slice(1):url.search:false;options.secure="secure"in options?options.secure:url.protocol==="https:"||url.protocol==="wss:";options.auth="auth"in options?options.auth:url.auth;options.pathname="pathname"in options?options.pathname:this.pathname.slice(1);options.port="port"in options?+options.port:+url.port||(options.secure?443:80);options.host="host"in options?options.host:url.hostname||url.host.replace(":"+url.port,"");this.emit("outgoing::url",options);var host=443!==options.port&&80!==options.port?options.host+":"+options.port:options.host;var querystring=this.querystring(options.query||"");querystring._primuscb=+new Date+"-"+this.stamps++;options.query=this.querystringify(querystring);server.push(options.secure?options.protocol+"s:":options.protocol+":","");if(options.auth)server.push(options.auth+"@"+host);else server.push(host);if(options.pathname)server.push(options.pathname);if(qsa)server.push("?"+options.query);else delete options.query;if(options.object)return options;return server.join("/")};Primus.prototype.emits=function emits(event,parser){var primus=this;return function emit(arg){var data=parser?parser.apply(primus,arguments):arg;setTimeout(function timeout(){primus.emit("incoming::"+event,data)},0)}};Primus.prototype.transform=function transform(type,fn){context(this,"transform");if(!(type in this.transformers)){return this.critical(new Error("Invalid transformer type"))}this.transformers[type].push(fn);return this};Primus.prototype.critical=function critical(err){if(this.listeners("error").length){this.emit("error",err);return this}throw err};Primus.connect=function connect(url,options){return new Primus(url,options)};Primus.EventEmitter=EventEmitter;Primus.prototype.client=function client(){var primus=this,socket;var Factory=function Factory(){if("undefined"!==typeof SockJS)return SockJS;try{return Primus.require("sockjs-client-node")}catch(e){}return undefined}();if(!Factory)return primus.critical(new Error("Missing required `sockjs-client-node` module. Please run `npm install --save sockjs-client-node`"));primus.on("outgoing::open",function opening(){primus.emit("outgoing::end");primus.socket=socket=new Factory(primus.uri({protocol:"http"}),null,primus.merge(primus.transport,{info:{websocket:!primus.AVOID_WEBSOCKETS,cookie_needed:true}}));socket.onopen=primus.emits("open");socket.onerror=primus.emits("error");socket.onclose=function(e){setTimeout(function timeout(){if(e&&e.code>1e3)primus.emit("incoming::error",e);primus.emit("incoming::end")},0)};socket.onmessage=primus.emits("data",function parse(evt){return evt.data})});primus.on("outgoing::data",function write(message){if(socket)socket.send(message)});primus.on("outgoing::reconnect",function reconnect(){primus.emit("outgoing::end");primus.emit("outgoing::open")});primus.on("outgoing::end",function close(){if(socket){socket.onerror=socket.onopen=socket.onclose=socket.onmessage=function(){};socket.close();socket=null}})};Primus.prototype.authorization=false;Primus.prototype.pathname="/hub";Primus.prototype.encoder=function encoder(data,fn){var err;try{data=JSON.stringify(data)}catch(e){err=e}fn(err,data)};Primus.prototype.decoder=function decoder(data,fn){var err;if("string"!==typeof data)return fn(err,data);try{data=JSON.parse(data)}catch(e){err=e}fn(err,data)};Primus.prototype.version="2.4.7";if("object"===typeof JSON&&"function"===typeof JSON.stringify&&JSON.stringify(["\u2028\u2029"])==='["\u2028\u2029"]'){JSON.stringify=function replace(stringify){var u2028=/\u2028/g,u2029=/\u2029/g;return function patched(value,replacer,spaces){var result=stringify.call(this,value,replacer,spaces);if(result){if(~result.indexOf("\u2028"))result=result.replace(u2028,"\\u2028");if(~result.indexOf("\u2029"))result=result.replace(u2029,"\\u2029")}return result}}(JSON.stringify)}if("undefined"!==typeof document&&"undefined"!==typeof navigator){if(document.addEventListener){document.addEventListener("keydown",function keydown(e){if(e.keyCode!==27||!e.preventDefault)return;e.preventDefault()},false)}var ua=(navigator.userAgent||"").toLowerCase(),parsed=ua.match(/.+(?:rv|it|ra|ie)[\/: ](\d+)\.(\d+)(?:\.(\d+))?/)||[],version=+[parsed[1],parsed[2]].join(".");if(!~ua.indexOf("chrome")&&~ua.indexOf("safari")&&version<534.54){Primus.prototype.AVOID_WEBSOCKETS=true}}return Primus});(function PrimusLibraryWrap(Primus){var JSON;JSON||(JSON={}),function(){function str(a,b){var c,d,e,f,g=gap,h,i=b[a];i&&typeof i=="object"&&typeof i.toJSON=="function"&&(i=i.toJSON(a)),typeof rep=="function"&&(i=rep.call(b,a,i));switch(typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";gap+=indent,h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1)h[c]=str(c,i)||"null";e=h.length===0?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g;return e}if(rep&&typeof rep=="object"){f=rep.length;for(c=0;c<f;c+=1)typeof rep[c]=="string"&&(d=rep[c],e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e))}else for(d in i)Object.prototype.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));e=h.length===0?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g;return e}}function quote(a){escapable.lastIndex=0;return escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return typeof b=="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function f(a){return a<10?"0"+a:a}"use strict",typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(a,b,c){var d;gap="",indent="";if(typeof c=="number")for(d=0;d<c;d+=1)indent+=" ";else typeof c=="string"&&(indent=c);rep=b;if(!b||typeof b=="function"||typeof b=="object"&&typeof b.length=="number")return str("",{"":a});throw new Error("JSON.stringify")}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&typeof e=="object")for(c in e)Object.prototype.hasOwnProperty.call(e,c)&&(d=walk(e,c),d!==undefined?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver=="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")})}();SockJS=function(){var _document=document;var _window=window;var utils={};var REventTarget=function(){};REventTarget.prototype.addEventListener=function(eventType,listener){if(!this._listeners){this._listeners={}}if(!(eventType in this._listeners)){this._listeners[eventType]=[]}var arr=this._listeners[eventType];if(utils.arrIndexOf(arr,listener)===-1){arr.push(listener)}return};REventTarget.prototype.removeEventListener=function(eventType,listener){if(!(this._listeners&&eventType in this._listeners)){return}var arr=this._listeners[eventType];var idx=utils.arrIndexOf(arr,listener);if(idx!==-1){if(arr.length>1){this._listeners[eventType]=arr.slice(0,idx).concat(arr.slice(idx+1))}else{delete this._listeners[eventType]}return}return};REventTarget.prototype.dispatchEvent=function(event){var t=event.type;var args=Array.prototype.slice.call(arguments,0);if(this["on"+t]){this["on"+t].apply(this,args)}if(this._listeners&&t in this._listeners){for(var i=0;i<this._listeners[t].length;i++){this._listeners[t][i].apply(this,args)}}};var SimpleEvent=function(type,obj){this.type=type;if(typeof obj!=="undefined"){for(var k in obj){if(!obj.hasOwnProperty(k))continue;this[k]=obj[k]}}};SimpleEvent.prototype.toString=function(){var r=[];for(var k in this){if(!this.hasOwnProperty(k))continue;var v=this[k];if(typeof v==="function")v="[function]";r.push(k+"="+v)}return"SimpleEvent("+r.join(", ")+")"};var EventEmitter=function(events){var that=this;that._events=events||[];that._listeners={}};EventEmitter.prototype.emit=function(type){var that=this;that._verifyType(type);if(that._nuked)return;var args=Array.prototype.slice.call(arguments,1);if(that["on"+type]){that["on"+type].apply(that,args)}if(type in that._listeners){for(var i=0;i<that._listeners[type].length;i++){that._listeners[type][i].apply(that,args)}}};EventEmitter.prototype.on=function(type,callback){var that=this;that._verifyType(type);if(that._nuked)return;if(!(type in that._listeners)){that._listeners[type]=[]}that._listeners[type].push(callback)};EventEmitter.prototype._verifyType=function(type){var that=this;if(utils.arrIndexOf(that._events,type)===-1){utils.log("Event "+JSON.stringify(type)+" not listed "+JSON.stringify(that._events)+" in "+that)}};EventEmitter.prototype.nuke=function(){var that=this;that._nuked=true;for(var i=0;i<that._events.length;i++){delete that[that._events[i]]}that._listeners={}};var random_string_chars="abcdefghijklmnopqrstuvwxyz0123456789_";utils.random_string=function(length,max){max=max||random_string_chars.length;var i,ret=[];for(i=0;i<length;i++){ret.push(random_string_chars.substr(Math.floor(Math.random()*max),1))}return ret.join("")};utils.random_number=function(max){return Math.floor(Math.random()*max)};utils.random_number_string=function(max){var t=(""+(max-1)).length;var p=Array(t+1).join("0");return(p+utils.random_number(max)).slice(-t)};utils.getOrigin=function(url){if(url.match(/^file:\/\//)){return null}var parts=url.split("/");var protocol=parts[0];var host=parts[2];var atSignIndex=host.lastIndexOf("@");var hostname;var port;if(~atSignIndex)host=host.slice(atSignIndex+1);parts=host.split(":");hostname=parts[0];port=parts[1];if(!port)port=protocol==="https:"?443:80;return protocol+"//"+hostname+":"+port};utils.isSameOriginUrl=function(url_a,url_b){if(!url_b)url_b=_window.location.href;return utils.getOrigin(url_a)===utils.getOrigin(url_b)};utils.getParentDomain=function(url){if(/^[0-9.]*$/.test(url))return url;if(/^\[/.test(url))return url;if(!/[.]/.test(url))return url;var parts=url.split(".").slice(1);return parts.join(".")};utils.objectExtend=function(dst,src){for(var k in src){if(src.hasOwnProperty(k)){dst[k]=src[k]}}return dst};var WPrefix="_jp";utils.polluteGlobalNamespace=function(){if(!(WPrefix in _window)){_window[WPrefix]={}}};utils.closeFrame=function(code,reason){return"c"+JSON.stringify([code,reason])};utils.userSetCode=function(code){return code===1e3||code>=3e3&&code<=4999};utils.countRTO=function(rtt){if(rtt>100)return 4*rtt;return 300+rtt};utils.log=function(){if(_window.console&&console.log&&console.log.apply){console.log.apply(console,arguments)}};utils.bind=function(fun,that){if(fun.bind){return fun.bind(that)}else{return function(){return fun.apply(that,arguments)}}};utils.flatUrl=function(url){return url.indexOf("?")===-1&&url.indexOf("#")===-1};utils.amendUrl=function(url){var dl=_document.location;if(!url){throw new Error("Wrong url for SockJS")}if(!utils.flatUrl(url)){throw new Error("Only basic urls are supported in SockJS")}if(url.indexOf("//")===0){url=dl.protocol+url}if(url.indexOf("/")===0){url=dl.protocol+"//"+dl.host+url}url=url.replace(/[/]+$/,"");return url};utils.arrIndexOf=function(arr,obj){for(var i=0;i<arr.length;i++){if(arr[i]===obj){return i}}return-1};utils.arrSkip=function(arr,obj){var idx=utils.arrIndexOf(arr,obj);if(idx===-1){return arr.slice()}else{var dst=arr.slice(0,idx);return dst.concat(arr.slice(idx+1))}};utils.isArray=Array.isArray||function(value){return{}.toString.call(value).indexOf("Array")>=0};utils.delay=function(t,fun){if(typeof t==="function"){fun=t;t=0}return setTimeout(fun,t)};var json_escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,json_lookup={"\0":"\\u0000","":"\\u0001","":"\\u0002","":"\\u0003","":"\\u0004","":"\\u0005","":"\\u0006","":"\\u0007","\b":"\\b","	":"\\t","\n":"\\n","":"\\u000b","\f":"\\f","\r":"\\r","":"\\u000e","":"\\u000f","":"\\u0010","":"\\u0011","":"\\u0012","":"\\u0013","":"\\u0014","":"\\u0015","":"\\u0016","":"\\u0017","":"\\u0018","":"\\u0019","":"\\u001a","":"\\u001b","":"\\u001c","":"\\u001d","":"\\u001e","":"\\u001f",'"':'\\"',"\\":"\\\\","":"\\u007f","¬Ä":"\\u0080","¬Å":"\\u0081","¬Ç":"\\u0082","¬É":"\\u0083","¬Ñ":"\\u0084","¬Ö":"\\u0085","¬Ü":"\\u0086","¬á":"\\u0087","¬à":"\\u0088","¬â":"\\u0089","¬ä":"\\u008a","¬ã":"\\u008b","¬å":"\\u008c","¬ç":"\\u008d","¬é":"\\u008e","¬è":"\\u008f","¬ê":"\\u0090","¬ë":"\\u0091","¬í":"\\u0092","¬ì":"\\u0093","¬î":"\\u0094","¬ï":"\\u0095","¬ñ":"\\u0096","¬ó":"\\u0097","¬ò":"\\u0098","¬ô":"\\u0099","¬ö":"\\u009a","¬õ":"\\u009b","¬ú":"\\u009c","¬ù":"\\u009d","¬û":"\\u009e","¬ü":"\\u009f","¬≠":"\\u00ad","ÿÄ":"\\u0600","ÿÅ":"\\u0601","ÿÇ":"\\u0602","ÿÉ":"\\u0603","ÿÑ":"\\u0604","‹è":"\\u070f","·û¥":"\\u17b4","·ûµ":"\\u17b5","‚Äå":"\\u200c","‚Äç":"\\u200d","‚Äé":"\\u200e","‚Äè":"\\u200f","\u2028":"\\u2028","\u2029":"\\u2029","‚Ä™":"\\u202a","‚Ä´":"\\u202b","‚Ä¨":"\\u202c","‚Ä≠":"\\u202d","‚ÄÆ":"\\u202e","‚ÄØ":"\\u202f","‚Å†":"\\u2060","‚Å°":"\\u2061","‚Å¢":"\\u2062","‚Å£":"\\u2063","‚Å§":"\\u2064","‚Å•":"\\u2065","‚Å¶":"\\u2066","‚Åß":"\\u2067","‚Å®":"\\u2068","‚Å©":"\\u2069","‚Å™":"\\u206a","‚Å´":"\\u206b","‚Å¨":"\\u206c","‚Å≠":"\\u206d","‚ÅÆ":"\\u206e","‚ÅØ":"\\u206f","Ôªø":"\\ufeff","Ôø∞":"\\ufff0","Ôø±":"\\ufff1","Ôø≤":"\\ufff2","Ôø≥":"\\ufff3","Ôø¥":"\\ufff4","Ôøµ":"\\ufff5","Ôø∂":"\\ufff6","Ôø∑":"\\ufff7","Ôø∏":"\\ufff8","Ôøπ":"\\ufff9","Ôø∫":"\\ufffa","Ôøª":"\\ufffb","Ôøº":"\\ufffc","ÔøΩ":"\\ufffd","Ôøæ":"\\ufffe","Ôøø":"\\uffff"};var extra_escapable=/[\x00-\x1f\ud800-\udfff\ufffe\uffff\u0300-\u0333\u033d-\u0346\u034a-\u034c\u0350-\u0352\u0357-\u0358\u035c-\u0362\u0374\u037e\u0387\u0591-\u05af\u05c4\u0610-\u0617\u0653-\u0654\u0657-\u065b\u065d-\u065e\u06df-\u06e2\u06eb-\u06ec\u0730\u0732-\u0733\u0735-\u0736\u073a\u073d\u073f-\u0741\u0743\u0745\u0747\u07eb-\u07f1\u0951\u0958-\u095f\u09dc-\u09dd\u09df\u0a33\u0a36\u0a59-\u0a5b\u0a5e\u0b5c-\u0b5d\u0e38-\u0e39\u0f43\u0f4d\u0f52\u0f57\u0f5c\u0f69\u0f72-\u0f76\u0f78\u0f80-\u0f83\u0f93\u0f9d\u0fa2\u0fa7\u0fac\u0fb9\u1939-\u193a\u1a17\u1b6b\u1cda-\u1cdb\u1dc0-\u1dcf\u1dfc\u1dfe\u1f71\u1f73\u1f75\u1f77\u1f79\u1f7b\u1f7d\u1fbb\u1fbe\u1fc9\u1fcb\u1fd3\u1fdb\u1fe3\u1feb\u1fee-\u1fef\u1ff9\u1ffb\u1ffd\u2000-\u2001\u20d0-\u20d1\u20d4-\u20d7\u20e7-\u20e9\u2126\u212a-\u212b\u2329-\u232a\u2adc\u302b-\u302c\uaab2-\uaab3\uf900-\ufa0d\ufa10\ufa12\ufa15-\ufa1e\ufa20\ufa22\ufa25-\ufa26\ufa2a-\ufa2d\ufa30-\ufa6d\ufa70-\ufad9\ufb1d\ufb1f\ufb2a-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufb4e\ufff0-\uffff]/g,extra_lookup;var JSONQuote=JSON&&JSON.stringify||function(string){json_escapable.lastIndex=0;if(json_escapable.test(string)){string=string.replace(json_escapable,function(a){return json_lookup[a]})}return'"'+string+'"'};var unroll_lookup=function(escapable){var i;var unrolled={};var c=[];for(i=0;i<65536;i++){c.push(String.fromCharCode(i))}escapable.lastIndex=0;c.join("").replace(escapable,function(a){unrolled[a]="\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4);return""});escapable.lastIndex=0;return unrolled};utils.quote=function(string){var quoted=JSONQuote(string);extra_escapable.lastIndex=0;if(!extra_escapable.test(quoted)){return quoted}if(!extra_lookup)extra_lookup=unroll_lookup(extra_escapable);return quoted.replace(extra_escapable,function(a){return extra_lookup[a]})};var _all_protocols=["websocket","xdr-streaming","xhr-streaming","iframe-eventsource","iframe-htmlfile","xdr-polling","xhr-polling","iframe-xhr-polling","jsonp-polling"];
utils.probeProtocols=function(){var probed={};for(var i=0;i<_all_protocols.length;i++){var protocol=_all_protocols[i];probed[protocol]=SockJS[protocol]&&SockJS[protocol].enabled()}return probed};utils.detectProtocols=function(probed,protocols_whitelist,info){var pe={},protocols=[];if(!protocols_whitelist)protocols_whitelist=_all_protocols;for(var i=0;i<protocols_whitelist.length;i++){var protocol=protocols_whitelist[i];pe[protocol]=probed[protocol]}var maybe_push=function(protos){var proto=protos.shift();if(pe[proto]){protocols.push(proto)}else{if(protos.length>0){maybe_push(protos)}}};if(info.websocket!==false){maybe_push(["websocket"])}if(pe["xhr-streaming"]&&!info.null_origin){protocols.push("xhr-streaming")}else{if(pe["xdr-streaming"]&&!info.cookie_needed&&!info.null_origin){protocols.push("xdr-streaming")}else{maybe_push(["iframe-eventsource","iframe-htmlfile"])}}if(pe["xhr-polling"]&&!info.null_origin){protocols.push("xhr-polling")}else{if(pe["xdr-polling"]&&!info.cookie_needed&&!info.null_origin){protocols.push("xdr-polling")}else{maybe_push(["iframe-xhr-polling","jsonp-polling"])}}return protocols};var MPrefix="_sockjs_global";utils.createHook=function(){var window_id="a"+utils.random_string(8);if(!(MPrefix in _window)){var map={};_window[MPrefix]=function(window_id){if(!(window_id in map)){map[window_id]={id:window_id,del:function(){delete map[window_id]}}}return map[window_id]}}return _window[MPrefix](window_id)};utils.attachMessage=function(listener){utils.attachEvent("message",listener)};utils.attachEvent=function(event,listener){if(typeof _window.addEventListener!=="undefined"){_window.addEventListener(event,listener,false)}else{_document.attachEvent("on"+event,listener);_window.attachEvent("on"+event,listener)}};utils.detachMessage=function(listener){utils.detachEvent("message",listener)};utils.detachEvent=function(event,listener){if(typeof _window.addEventListener!=="undefined"){_window.removeEventListener(event,listener,false)}else{_document.detachEvent("on"+event,listener);_window.detachEvent("on"+event,listener)}};var on_unload={};var after_unload=false;var trigger_unload_callbacks=function(){for(var ref in on_unload){on_unload[ref]();delete on_unload[ref]}};var unload_triggered=function(){if(after_unload)return;after_unload=true;trigger_unload_callbacks()};utils.attachEvent("unload",unload_triggered);utils.unload_add=function(listener){var ref=utils.random_string(8);on_unload[ref]=listener;if(after_unload){utils.delay(trigger_unload_callbacks)}return ref};utils.unload_del=function(ref){if(ref in on_unload)delete on_unload[ref]};utils.createIframe=function(iframe_url,error_callback){var iframe=_document.createElement("iframe");var tref,unload_ref;var unattach=function(){clearTimeout(tref);try{iframe.onload=null}catch(x){}iframe.onerror=null};var cleanup=function(){if(iframe){unattach();setTimeout(function(){if(iframe){iframe.parentNode.removeChild(iframe)}iframe=null},0);utils.unload_del(unload_ref)}};var onerror=function(r){if(iframe){cleanup();error_callback(r)}};var post=function(msg,origin){try{if(iframe&&iframe.contentWindow){iframe.contentWindow.postMessage(msg,origin)}}catch(x){}};iframe.src=iframe_url;iframe.style.display="none";iframe.style.position="absolute";iframe.onerror=function(){onerror("onerror")};iframe.onload=function(){clearTimeout(tref);tref=setTimeout(function(){onerror("onload timeout")},2e3)};_document.body.appendChild(iframe);tref=setTimeout(function(){onerror("timeout")},15e3);unload_ref=utils.unload_add(cleanup);return{post:post,cleanup:cleanup,loaded:unattach}};utils.createHtmlfile=function(iframe_url,error_callback){var doc=new ActiveXObject("htmlfile");var tref,unload_ref;var iframe;var unattach=function(){clearTimeout(tref)};var cleanup=function(){if(doc){unattach();utils.unload_del(unload_ref);iframe.parentNode.removeChild(iframe);iframe=doc=null;CollectGarbage()}};var onerror=function(r){if(doc){cleanup();error_callback(r)}};var post=function(msg,origin){try{if(iframe&&iframe.contentWindow){iframe.contentWindow.postMessage(msg,origin)}}catch(x){}};doc.open();doc.write("<html><s"+"cript>"+'document.domain="'+document.domain+'";'+"</s"+"cript></html>");doc.close();doc.parentWindow[WPrefix]=_window[WPrefix];var c=doc.createElement("div");doc.body.appendChild(c);iframe=doc.createElement("iframe");c.appendChild(iframe);iframe.src=iframe_url;tref=setTimeout(function(){onerror("timeout")},15e3);unload_ref=utils.unload_add(cleanup);return{post:post,cleanup:cleanup,loaded:unattach}};var AbstractXHRObject=function(){};AbstractXHRObject.prototype=new EventEmitter(["chunk","finish"]);AbstractXHRObject.prototype._start=function(method,url,payload,opts){var that=this;try{that.xhr=new XMLHttpRequest}catch(x){}if(!that.xhr){try{that.xhr=new _window.ActiveXObject("Microsoft.XMLHTTP")}catch(x){}}if(_window.ActiveXObject||_window.XDomainRequest){url+=(url.indexOf("?")===-1?"?":"&")+"t="+ +new Date}that.unload_ref=utils.unload_add(function(){that._cleanup(true)});try{that.xhr.open(method,url,true)}catch(e){that.emit("finish",0,"");that._cleanup();return}if(!opts||!opts.no_credentials){that.xhr.withCredentials="true"}if(opts&&opts.headers){for(var key in opts.headers){that.xhr.setRequestHeader(key,opts.headers[key])}}that.xhr.onreadystatechange=function(){if(that.xhr){var x=that.xhr;switch(x.readyState){case 3:try{var status=x.status;var text=x.responseText}catch(x){};if(status===1223)status=204;if(text&&text.length>0){that.emit("chunk",status,text)}break;case 4:var status=x.status;if(status===1223)status=204;that.emit("finish",status,x.responseText);that._cleanup(false);break}}};that.xhr.send(payload)};AbstractXHRObject.prototype._cleanup=function(abort){var that=this;if(!that.xhr)return;utils.unload_del(that.unload_ref);that.xhr.onreadystatechange=function(){};if(abort){try{that.xhr.abort()}catch(x){}}that.unload_ref=that.xhr=null};AbstractXHRObject.prototype.close=function(){var that=this;that.nuke();that._cleanup(true)};var XHRCorsObject=utils.XHRCorsObject=function(){var that=this,args=arguments;utils.delay(function(){that._start.apply(that,args)})};XHRCorsObject.prototype=new AbstractXHRObject;var XHRLocalObject=utils.XHRLocalObject=function(method,url,payload){var that=this;utils.delay(function(){that._start(method,url,payload)})};XHRLocalObject.prototype=new AbstractXHRObject;var XDRObject=utils.XDRObject=function(method,url,payload){var that=this;utils.delay(function(){that._start(method,url,payload)})};XDRObject.prototype=new EventEmitter(["chunk","finish"]);XDRObject.prototype._start=function(method,url,payload){var that=this;var xdr=new XDomainRequest;url+=(url.indexOf("?")===-1?"?":"&")+"t="+ +new Date;var onerror=xdr.ontimeout=xdr.onerror=function(){that.emit("finish",0,"");that._cleanup(false)};xdr.onprogress=function(){that.emit("chunk",200,xdr.responseText)};xdr.onload=function(){that.emit("finish",200,xdr.responseText);that._cleanup(false)};that.xdr=xdr;that.unload_ref=utils.unload_add(function(){that._cleanup(true)});try{that.xdr.open(method,url);that.xdr.send(payload)}catch(x){onerror()}};XDRObject.prototype._cleanup=function(abort){var that=this;if(!that.xdr)return;utils.unload_del(that.unload_ref);that.xdr.ontimeout=that.xdr.onerror=that.xdr.onprogress=that.xdr.onload=null;if(abort){try{that.xdr.abort()}catch(x){}}that.unload_ref=that.xdr=null};XDRObject.prototype.close=function(){var that=this;that.nuke();that._cleanup(true)};utils.isXHRCorsCapable=function(){if(_document.domain){if(_window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest){return 1}if(_window.XDomainRequest){return 2}}if(IframeTransport.enabled()){return 3}return 4};var SockJS=function(url,dep_protocols_whitelist,options){if(this===_window){return new SockJS(url,dep_protocols_whitelist,options)}var that=this,protocols_whitelist;that._options={devel:false,debug:false,protocols_whitelist:[],info:undefined,rtt:undefined};if(options){utils.objectExtend(that._options,options)}that._base_url=utils.amendUrl(url);that._server=that._options.server||utils.random_number_string(1e3);if(that._options.protocols_whitelist&&that._options.protocols_whitelist.length){protocols_whitelist=that._options.protocols_whitelist}else{if(typeof dep_protocols_whitelist==="string"&&dep_protocols_whitelist.length>0){protocols_whitelist=[dep_protocols_whitelist]}else if(utils.isArray(dep_protocols_whitelist)){protocols_whitelist=dep_protocols_whitelist}else{protocols_whitelist=null}if(protocols_whitelist){that._debug('Deprecated API: Use "protocols_whitelist" option '+"instead of supplying protocol list as a second "+"parameter to SockJS constructor.")}}that._protocols=[];that.protocol=null;that.readyState=SockJS.CONNECTING;that._ir=createInfoReceiver(that._base_url);that._ir.onfinish=function(info,rtt){that._ir=null;if(info){if(that._options.info){info=utils.objectExtend(info,that._options.info)}if(that._options.rtt){rtt=that._options.rtt}that._applyInfo(info,rtt,protocols_whitelist);that._didClose()}else{that._didClose(1002,"Can't connect to server",true)}}};SockJS.prototype=new REventTarget;SockJS.version="0.3.4";SockJS.CONNECTING=0;SockJS.OPEN=1;SockJS.CLOSING=2;SockJS.CLOSED=3;SockJS.prototype._debug=function(){if(this._options.debug)utils.log.apply(utils,arguments)};SockJS.prototype._dispatchOpen=function(){var that=this;if(that.readyState===SockJS.CONNECTING){if(that._transport_tref){clearTimeout(that._transport_tref);that._transport_tref=null}that.readyState=SockJS.OPEN;that.dispatchEvent(new SimpleEvent("open"))}else{that._didClose(1006,"Server lost session")}};SockJS.prototype._dispatchMessage=function(data){var that=this;if(that.readyState!==SockJS.OPEN)return;that.dispatchEvent(new SimpleEvent("message",{data:data}))};SockJS.prototype._dispatchHeartbeat=function(data){var that=this;if(that.readyState!==SockJS.OPEN)return;that.dispatchEvent(new SimpleEvent("heartbeat",{}))};SockJS.prototype._didClose=function(code,reason,force){var that=this;if(that.readyState!==SockJS.CONNECTING&&that.readyState!==SockJS.OPEN&&that.readyState!==SockJS.CLOSING)throw new Error("INVALID_STATE_ERR");if(that._ir){that._ir.nuke();that._ir=null}if(that._transport){that._transport.doCleanup();that._transport=null}var close_event=new SimpleEvent("close",{code:code,reason:reason,wasClean:utils.userSetCode(code)});if(!utils.userSetCode(code)&&that.readyState===SockJS.CONNECTING&&!force){if(that._try_next_protocol(close_event)){return}close_event=new SimpleEvent("close",{code:2e3,reason:"All transports failed",wasClean:false,last_event:close_event})}that.readyState=SockJS.CLOSED;utils.delay(function(){that.dispatchEvent(close_event)})};SockJS.prototype._didMessage=function(data){var that=this;var type=data.slice(0,1);switch(type){case"o":that._dispatchOpen();break;case"a":var payload=JSON.parse(data.slice(1)||"[]");for(var i=0;i<payload.length;i++){that._dispatchMessage(payload[i])}break;case"m":var payload=JSON.parse(data.slice(1)||"null");that._dispatchMessage(payload);break;case"c":var payload=JSON.parse(data.slice(1)||"[]");that._didClose(payload[0],payload[1]);break;case"h":that._dispatchHeartbeat();break}};SockJS.prototype._try_next_protocol=function(close_event){var that=this;if(that.protocol){that._debug("Closed transport:",that.protocol,""+close_event);that.protocol=null}if(that._transport_tref){clearTimeout(that._transport_tref);that._transport_tref=null}while(1){var protocol=that.protocol=that._protocols.shift();if(!protocol){return false}if(SockJS[protocol]&&SockJS[protocol].need_body===true&&(!_document.body||typeof _document.readyState!=="undefined"&&_document.readyState!=="complete")){that._protocols.unshift(protocol);that.protocol="waiting-for-load";utils.attachEvent("load",function(){that._try_next_protocol()});return true}if(!SockJS[protocol]||!SockJS[protocol].enabled(that._options)){that._debug("Skipping transport:",protocol)}else{var roundTrips=SockJS[protocol].roundTrips||1;var to=(that._options.rto||0)*roundTrips||5e3;that._transport_tref=utils.delay(to,function(){if(that.readyState===SockJS.CONNECTING){that._didClose(2007,"Transport timeouted")}});var connid=utils.random_string(8);var trans_url=that._base_url+"/"+that._server+"/"+connid;that._debug("Opening transport:",protocol," url:"+trans_url," RTO:"+that._options.rto);that._transport=new SockJS[protocol](that,trans_url,that._base_url);return true}}};SockJS.prototype.close=function(code,reason){var that=this;if(code&&!utils.userSetCode(code))throw new Error("INVALID_ACCESS_ERR");if(that.readyState!==SockJS.CONNECTING&&that.readyState!==SockJS.OPEN){return false}that.readyState=SockJS.CLOSING;that._didClose(code||1e3,reason||"Normal closure");return true};SockJS.prototype.send=function(data){var that=this;if(that.readyState===SockJS.CONNECTING)throw new Error("INVALID_STATE_ERR");if(that.readyState===SockJS.OPEN){that._transport.doSend(utils.quote(""+data))}return true};SockJS.prototype._applyInfo=function(info,rtt,protocols_whitelist){var that=this;that._options.info=info;that._options.rtt=rtt;that._options.rto=utils.countRTO(rtt);that._options.info.null_origin=!_document.domain;var probed=utils.probeProtocols();that._protocols=utils.detectProtocols(probed,protocols_whitelist,info)};var WebSocketTransport=SockJS.websocket=function(ri,trans_url){var that=this;var url=trans_url+"/websocket";if(url.slice(0,5)==="https"){url="wss"+url.slice(5)}else{url="ws"+url.slice(4)}that.ri=ri;that.url=url;var Constructor=_window.WebSocket||_window.MozWebSocket;that.ws=new Constructor(that.url);that.ws.onmessage=function(e){that.ri._didMessage(e.data)};that.ws.onerror=function(){ri._didMessage(utils.closeFrame(1006,"WebSocket connection broken"))};that.unload_ref=utils.unload_add(function(){that.ws.close()});that.ws.onclose=function(){that.ri._didMessage(utils.closeFrame(1006,"WebSocket connection broken"))}};WebSocketTransport.prototype.doSend=function(data){this.ws.send("["+data+"]")};WebSocketTransport.prototype.doCleanup=function(){var that=this;var ws=that.ws;if(ws){ws.onmessage=ws.onclose=ws.onerror=null;ws.close();utils.unload_del(that.unload_ref);that.unload_ref=that.ri=that.ws=null}};WebSocketTransport.enabled=function(){return!!(_window.WebSocket||_window.MozWebSocket)};WebSocketTransport.roundTrips=2;var BufferedSender=function(){};BufferedSender.prototype.send_constructor=function(sender){var that=this;that.send_buffer=[];that.sender=sender};BufferedSender.prototype.doSend=function(message){var that=this;that.send_buffer.push(message);if(!that.send_stop){that.send_schedule()}};BufferedSender.prototype.send_schedule_wait=function(){var that=this;var tref;that.send_stop=function(){that.send_stop=null;clearTimeout(tref)};tref=utils.delay(25,function(){that.send_stop=null;that.send_schedule()})};BufferedSender.prototype.send_schedule=function(){var that=this;if(that.send_buffer.length>0){var payload="["+that.send_buffer.join(",")+"]";that.send_stop=that.sender(that.trans_url,payload,function(success,abort_reason){that.send_stop=null;if(success===false){that.ri._didClose(1006,"Sending error "+abort_reason)}else{that.send_schedule_wait()}});that.send_buffer=[]}};BufferedSender.prototype.send_destructor=function(){var that=this;if(that._send_stop){that._send_stop()}that._send_stop=null};var jsonPGenericSender=function(url,payload,callback){var that=this;if(!("_send_form"in that)){var form=that._send_form=_document.createElement("form");var area=that._send_area=_document.createElement("textarea");area.name="d";form.style.display="none";form.style.position="absolute";form.method="POST";form.enctype="application/x-www-form-urlencoded";form.acceptCharset="UTF-8";form.appendChild(area);_document.body.appendChild(form)}var form=that._send_form;var area=that._send_area;var id="a"+utils.random_string(8);form.target=id;form.action=url+"/jsonp_send?i="+id;var iframe;try{iframe=_document.createElement('<iframe name="'+id+'">')}catch(x){iframe=_document.createElement("iframe");iframe.name=id}iframe.id=id;form.appendChild(iframe);iframe.style.display="none";try{area.value=payload}catch(e){utils.log("Your browser is seriously broken. Go home! "+e.message)}form.submit();var completed=function(e){if(!iframe.onerror)return;iframe.onreadystatechange=iframe.onerror=iframe.onload=null;utils.delay(500,function(){iframe.parentNode.removeChild(iframe);iframe=null});area.value="";callback(true)};iframe.onerror=iframe.onload=completed;iframe.onreadystatechange=function(e){if(iframe.readyState=="complete")completed()};return completed};var createAjaxSender=function(AjaxObject){return function(url,payload,callback){var xo=new AjaxObject("POST",url+"/xhr_send",payload);xo.onfinish=function(status,text){callback(status===200||status===204,"http status "+status)};return function(abort_reason){callback(false,abort_reason)}}};var jsonPGenericReceiver=function(url,callback){var tref;var script=_document.createElement("script");var script2;var close_script=function(frame){if(script2){script2.parentNode.removeChild(script2);script2=null}if(script){clearTimeout(tref);script.parentNode.removeChild(script);script.onreadystatechange=script.onerror=script.onload=script.onclick=null;script=null;callback(frame);callback=null}};var loaded_okay=false;var error_timer=null;script.id="a"+utils.random_string(8);script.src=url;script.type="text/javascript";script.charset="UTF-8";script.onerror=function(e){if(!error_timer){error_timer=setTimeout(function(){if(!loaded_okay){close_script(utils.closeFrame(1006,"JSONP script loaded abnormally (onerror)"))}},1e3)}};script.onload=function(e){close_script(utils.closeFrame(1006,"JSONP script loaded abnormally (onload)"))};script.onreadystatechange=function(e){if(/loaded|closed/.test(script.readyState)){if(script&&script.htmlFor&&script.onclick){loaded_okay=true;try{script.onclick()}catch(x){}}if(script){close_script(utils.closeFrame(1006,"JSONP script loaded abnormally (onreadystatechange)"))}}};if(typeof script.async==="undefined"&&_document.attachEvent){if(!/opera/i.test(navigator.userAgent)){try{script.htmlFor=script.id;script.event="onclick"}catch(x){}script.async=true}else{script2=_document.createElement("script");script2.text="try{var a = document.getElementById('"+script.id+"'); if(a)a.onerror();}catch(x){};";script.async=script2.async=false}}if(typeof script.async!=="undefined"){script.async=true}tref=setTimeout(function(){close_script(utils.closeFrame(1006,"JSONP script loaded abnormally (timeout)"))},35e3);var head=_document.getElementsByTagName("head")[0];head.insertBefore(script,head.firstChild);if(script2){head.insertBefore(script2,head.firstChild)}return close_script};var JsonPTransport=SockJS["jsonp-polling"]=function(ri,trans_url){utils.polluteGlobalNamespace();var that=this;that.ri=ri;that.trans_url=trans_url;that.send_constructor(jsonPGenericSender);that._schedule_recv()};JsonPTransport.prototype=new BufferedSender;JsonPTransport.prototype._schedule_recv=function(){var that=this;var callback=function(data){that._recv_stop=null;if(data){if(!that._is_closing){that.ri._didMessage(data)}}if(!that._is_closing){that._schedule_recv()}};that._recv_stop=jsonPReceiverWrapper(that.trans_url+"/jsonp",jsonPGenericReceiver,callback)};JsonPTransport.enabled=function(){return true};JsonPTransport.need_body=true;JsonPTransport.prototype.doCleanup=function(){var that=this;that._is_closing=true;if(that._recv_stop){that._recv_stop()}that.ri=that._recv_stop=null;that.send_destructor()};var jsonPReceiverWrapper=function(url,constructReceiver,user_callback){var id="a"+utils.random_string(6);var url_id=url+"?c="+escape(WPrefix+"."+id);var aborting=0;var callback=function(frame){switch(aborting){case 0:delete _window[WPrefix][id];user_callback(frame);break;case 1:user_callback(frame);aborting=2;break;case 2:delete _window[WPrefix][id];break}};var close_script=constructReceiver(url_id,callback);_window[WPrefix][id]=close_script;var stop=function(){if(_window[WPrefix][id]){aborting=1;_window[WPrefix][id](utils.closeFrame(1e3,"JSONP user aborted read"))}};return stop};var AjaxBasedTransport=function(){};AjaxBasedTransport.prototype=new BufferedSender;AjaxBasedTransport.prototype.run=function(ri,trans_url,url_suffix,Receiver,AjaxObject){var that=this;that.ri=ri;that.trans_url=trans_url;that.send_constructor(createAjaxSender(AjaxObject));that.poll=new Polling(ri,Receiver,trans_url+url_suffix,AjaxObject)};AjaxBasedTransport.prototype.doCleanup=function(){var that=this;if(that.poll){that.poll.abort();that.poll=null}};var XhrStreamingTransport=SockJS["xhr-streaming"]=function(ri,trans_url){this.run(ri,trans_url,"/xhr_streaming",XhrReceiver,utils.XHRCorsObject)};XhrStreamingTransport.prototype=new AjaxBasedTransport;XhrStreamingTransport.enabled=function(){return _window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest&&!/opera/i.test(navigator.userAgent)};XhrStreamingTransport.roundTrips=2;XhrStreamingTransport.need_body=true;var XdrStreamingTransport=SockJS["xdr-streaming"]=function(ri,trans_url){this.run(ri,trans_url,"/xhr_streaming",XhrReceiver,utils.XDRObject)};XdrStreamingTransport.prototype=new AjaxBasedTransport;XdrStreamingTransport.enabled=function(){return!!_window.XDomainRequest};XdrStreamingTransport.roundTrips=2;var XhrPollingTransport=SockJS["xhr-polling"]=function(ri,trans_url){this.run(ri,trans_url,"/xhr",XhrReceiver,utils.XHRCorsObject)};XhrPollingTransport.prototype=new AjaxBasedTransport;XhrPollingTransport.enabled=XhrStreamingTransport.enabled;XhrPollingTransport.roundTrips=2;var XdrPollingTransport=SockJS["xdr-polling"]=function(ri,trans_url){this.run(ri,trans_url,"/xhr",XhrReceiver,utils.XDRObject)};XdrPollingTransport.prototype=new AjaxBasedTransport;XdrPollingTransport.enabled=XdrStreamingTransport.enabled;XdrPollingTransport.roundTrips=2;var IframeTransport=function(){};IframeTransport.prototype.i_constructor=function(ri,trans_url,base_url){var that=this;that.ri=ri;that.origin=utils.getOrigin(base_url);that.base_url=base_url;that.trans_url=trans_url;var iframe_url=base_url+"/iframe.html";if(that.ri._options.devel){iframe_url+="?t="+ +new Date}that.window_id=utils.random_string(8);iframe_url+="#"+that.window_id;that.iframeObj=utils.createIframe(iframe_url,function(r){that.ri._didClose(1006,"Unable to load an iframe ("+r+")")});that.onmessage_cb=utils.bind(that.onmessage,that);utils.attachMessage(that.onmessage_cb)};IframeTransport.prototype.doCleanup=function(){var that=this;if(that.iframeObj){utils.detachMessage(that.onmessage_cb);try{if(that.iframeObj.iframe.contentWindow){that.postMessage("c")}}catch(x){}that.iframeObj.cleanup();that.iframeObj=null;that.onmessage_cb=that.iframeObj=null}};IframeTransport.prototype.onmessage=function(e){var that=this;if(!utils.isSameOriginUrl(e.origin,that.origin))return;var window_id=e.data.slice(0,8);var type=e.data.slice(8,9);var data=e.data.slice(9);if(window_id!==that.window_id)return;switch(type){case"s":that.iframeObj.loaded();that.postMessage("s",JSON.stringify([SockJS.version,that.protocol,that.trans_url,that.base_url]));break;case"t":that.ri._didMessage(data);break}};IframeTransport.prototype.postMessage=function(type,data){var that=this;that.iframeObj.post(that.window_id+type+(data||""),that.origin)};IframeTransport.prototype.doSend=function(message){this.postMessage("m",message)};IframeTransport.enabled=function(){var konqueror=navigator&&navigator.userAgent&&navigator.userAgent.indexOf("Konqueror")!==-1;return(typeof _window.postMessage==="function"||typeof _window.postMessage==="object")&&!konqueror};var curr_window_id;var postMessage=function(type,data){if(parent!==_window){parent.postMessage(curr_window_id+type+(data||""),"*")}else{utils.log("Can't postMessage, no parent window.",type,data)}};var FacadeJS=function(){};FacadeJS.prototype._didClose=function(code,reason){postMessage("t",utils.closeFrame(code,reason))};FacadeJS.prototype._didMessage=function(frame){postMessage("t",frame)};FacadeJS.prototype._doSend=function(data){this._transport.doSend(data)};FacadeJS.prototype._doCleanup=function(){this._transport.doCleanup()};utils.parent_origin=undefined;SockJS.bootstrap_iframe=function(){var facade;curr_window_id=_document.location.hash.slice(1);var onMessage=function(e){if(e.source!==parent)return;if(typeof utils.parent_origin==="undefined")utils.parent_origin=e.origin;if(e.origin!==utils.parent_origin)return;var window_id=e.data.slice(0,8);var type=e.data.slice(8,9);var data=e.data.slice(9);if(window_id!==curr_window_id)return;switch(type){case"s":var p=JSON.parse(data);var version=p[0];var protocol=p[1];var trans_url=p[2];var base_url=p[3];if(version!==SockJS.version){utils.log("Incompatibile SockJS! Main site uses:"+' "'+version+'", the iframe:'+' "'+SockJS.version+'".')}if(!utils.flatUrl(trans_url)||!utils.flatUrl(base_url)){utils.log("Only basic urls are supported in SockJS");return}if(!utils.isSameOriginUrl(trans_url)||!utils.isSameOriginUrl(base_url)){utils.log("Can't connect to different domain from within an "+"iframe. ("+JSON.stringify([_window.location.href,trans_url,base_url])+")");return}facade=new FacadeJS;facade._transport=new FacadeJS[protocol](facade,trans_url,base_url);break;case"m":facade._doSend(data);break;case"c":if(facade)facade._doCleanup();facade=null;break}};utils.attachMessage(onMessage);postMessage("s")};var InfoReceiver=function(base_url,AjaxObject){var that=this;utils.delay(function(){that.doXhr(base_url,AjaxObject)})};InfoReceiver.prototype=new EventEmitter(["finish"]);InfoReceiver.prototype.doXhr=function(base_url,AjaxObject){var that=this;var t0=(new Date).getTime();var xo=new AjaxObject("GET",base_url+"/info");var tref=utils.delay(8e3,function(){xo.ontimeout()});xo.onfinish=function(status,text){clearTimeout(tref);tref=null;if(status===200){var rtt=(new Date).getTime()-t0;var info=JSON.parse(text);if(typeof info!=="object")info={};that.emit("finish",info,rtt)}else{that.emit("finish")}};xo.ontimeout=function(){xo.close();that.emit("finish")}};var InfoReceiverIframe=function(base_url){var that=this;var go=function(){var ifr=new IframeTransport;ifr.protocol="w-iframe-info-receiver";var fun=function(r){if(typeof r==="string"&&r.substr(0,1)==="m"){var d=JSON.parse(r.substr(1));var info=d[0],rtt=d[1];that.emit("finish",info,rtt)}else{that.emit("finish")}ifr.doCleanup();ifr=null};var mock_ri={_options:{},_didClose:fun,_didMessage:fun};ifr.i_constructor(mock_ri,base_url,base_url)};if(!_document.body){utils.attachEvent("load",go)}else{go()}};InfoReceiverIframe.prototype=new EventEmitter(["finish"]);var InfoReceiverFake=function(){var that=this;utils.delay(function(){that.emit("finish",{},2e3)})};InfoReceiverFake.prototype=new EventEmitter(["finish"]);var createInfoReceiver=function(base_url){if(utils.isSameOriginUrl(base_url)){return new InfoReceiver(base_url,utils.XHRLocalObject)}switch(utils.isXHRCorsCapable()){case 1:return new InfoReceiver(base_url,utils.XHRLocalObject);case 2:return new InfoReceiver(base_url,utils.XDRObject);case 3:return new InfoReceiverIframe(base_url);default:return new InfoReceiverFake}};var WInfoReceiverIframe=FacadeJS["w-iframe-info-receiver"]=function(ri,_trans_url,base_url){var ir=new InfoReceiver(base_url,utils.XHRLocalObject);ir.onfinish=function(info,rtt){ri._didMessage("m"+JSON.stringify([info,rtt]));ri._didClose()}};WInfoReceiverIframe.prototype.doCleanup=function(){};var EventSourceIframeTransport=SockJS["iframe-eventsource"]=function(){var that=this;that.protocol="w-iframe-eventsource";that.i_constructor.apply(that,arguments)};EventSourceIframeTransport.prototype=new IframeTransport;EventSourceIframeTransport.enabled=function(){return"EventSource"in _window&&IframeTransport.enabled()};EventSourceIframeTransport.need_body=true;EventSourceIframeTransport.roundTrips=3;var EventSourceTransport=FacadeJS["w-iframe-eventsource"]=function(ri,trans_url){this.run(ri,trans_url,"/eventsource",EventSourceReceiver,utils.XHRLocalObject)};EventSourceTransport.prototype=new AjaxBasedTransport;var XhrPollingIframeTransport=SockJS["iframe-xhr-polling"]=function(){var that=this;that.protocol="w-iframe-xhr-polling";that.i_constructor.apply(that,arguments)};XhrPollingIframeTransport.prototype=new IframeTransport;XhrPollingIframeTransport.enabled=function(){return _window.XMLHttpRequest&&IframeTransport.enabled()};XhrPollingIframeTransport.need_body=true;XhrPollingIframeTransport.roundTrips=3;var XhrPollingITransport=FacadeJS["w-iframe-xhr-polling"]=function(ri,trans_url){this.run(ri,trans_url,"/xhr",XhrReceiver,utils.XHRLocalObject)};XhrPollingITransport.prototype=new AjaxBasedTransport;var HtmlFileIframeTransport=SockJS["iframe-htmlfile"]=function(){var that=this;that.protocol="w-iframe-htmlfile";that.i_constructor.apply(that,arguments)};HtmlFileIframeTransport.prototype=new IframeTransport;HtmlFileIframeTransport.enabled=function(){return IframeTransport.enabled()};HtmlFileIframeTransport.need_body=true;HtmlFileIframeTransport.roundTrips=3;var HtmlFileTransport=FacadeJS["w-iframe-htmlfile"]=function(ri,trans_url){this.run(ri,trans_url,"/htmlfile",HtmlfileReceiver,utils.XHRLocalObject)};HtmlFileTransport.prototype=new AjaxBasedTransport;var Polling=function(ri,Receiver,recv_url,AjaxObject){var that=this;that.ri=ri;that.Receiver=Receiver;that.recv_url=recv_url;that.AjaxObject=AjaxObject;that._scheduleRecv()};Polling.prototype._scheduleRecv=function(){var that=this;var poll=that.poll=new that.Receiver(that.recv_url,that.AjaxObject);var msg_counter=0;poll.onmessage=function(e){msg_counter+=1;that.ri._didMessage(e.data)};poll.onclose=function(e){that.poll=poll=poll.onmessage=poll.onclose=null;if(!that.poll_is_closing){if(e.reason==="permanent"){that.ri._didClose(1006,"Polling error ("+e.reason+")")}else{that._scheduleRecv()}}}};Polling.prototype.abort=function(){var that=this;that.poll_is_closing=true;if(that.poll){that.poll.abort()}};var EventSourceReceiver=function(url){var that=this;var es=new EventSource(url);es.onmessage=function(e){that.dispatchEvent(new SimpleEvent("message",{data:unescape(e.data)}))};that.es_close=es.onerror=function(e,abort_reason){var reason=abort_reason?"user":es.readyState!==2?"network":"permanent";that.es_close=es.onmessage=es.onerror=null;es.close();es=null;utils.delay(200,function(){that.dispatchEvent(new SimpleEvent("close",{reason:reason}))})}};EventSourceReceiver.prototype=new REventTarget;EventSourceReceiver.prototype.abort=function(){var that=this;if(that.es_close){that.es_close({},true)}};var _is_ie_htmlfile_capable;var isIeHtmlfileCapable=function(){if(_is_ie_htmlfile_capable===undefined){if("ActiveXObject"in _window){try{_is_ie_htmlfile_capable=!!new ActiveXObject("htmlfile")}catch(x){}}else{_is_ie_htmlfile_capable=false}}return _is_ie_htmlfile_capable};var HtmlfileReceiver=function(url){var that=this;utils.polluteGlobalNamespace();that.id="a"+utils.random_string(6,26);url+=(url.indexOf("?")===-1?"?":"&")+"c="+escape(WPrefix+"."+that.id);var constructor=isIeHtmlfileCapable()?utils.createHtmlfile:utils.createIframe;var iframeObj;_window[WPrefix][that.id]={start:function(){iframeObj.loaded()},message:function(data){that.dispatchEvent(new SimpleEvent("message",{data:data}))},stop:function(){that.iframe_close({},"network")}};that.iframe_close=function(e,abort_reason){iframeObj.cleanup();that.iframe_close=iframeObj=null;delete _window[WPrefix][that.id];that.dispatchEvent(new SimpleEvent("close",{reason:abort_reason}))};iframeObj=constructor(url,function(e){that.iframe_close({},"permanent")})};HtmlfileReceiver.prototype=new REventTarget;HtmlfileReceiver.prototype.abort=function(){var that=this;if(that.iframe_close){that.iframe_close({},"user")}};var XhrReceiver=function(url,AjaxObject){var that=this;var buf_pos=0;that.xo=new AjaxObject("POST",url,null);that.xo.onchunk=function(status,text){if(status!==200)return;while(1){var buf=text.slice(buf_pos);var p=buf.indexOf("\n");if(p===-1)break;buf_pos+=p+1;var msg=buf.slice(0,p);that.dispatchEvent(new SimpleEvent("message",{data:msg}))}};that.xo.onfinish=function(status,text){that.xo.onchunk(status,text);that.xo=null;var reason=status===200?"network":"permanent";that.dispatchEvent(new SimpleEvent("close",{reason:reason}))
}};XhrReceiver.prototype=new REventTarget;XhrReceiver.prototype.abort=function(){var that=this;if(that.xo){that.xo.close();that.dispatchEvent(new SimpleEvent("close",{reason:"user"}));that.xo=null}};SockJS.getUtils=function(){return utils};SockJS.getIframeTransport=function(){return IframeTransport};return SockJS}();if("_sockjs_onload"in window)setTimeout(_sockjs_onload,1);if(typeof define==="function"&&define.amd){define("sockjs",[],function(){return SockJS})}})(this["Primus"]);