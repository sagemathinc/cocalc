#!/usr/bin/env node

const fs = require("fs");
const path = require("path");

const root = path.resolve(__dirname, "..");
const apiRoot = path.join(root, "pages", "api", "v2");
const outFile = path.join(root, "lib", "api-v2-manifest.ts");

function collectFiles(dir) {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  const out = [];
  for (const entry of entries) {
    if (entry.name.startsWith(".")) {
      continue;
    }
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      out.push(...collectFiles(fullPath));
      continue;
    }
    out.push(fullPath);
  }
  return out;
}

function isApiFile(file) {
  if (file.endsWith(".d.ts")) {
    return false;
  }
  if (file.endsWith(".test.ts") || file.endsWith(".spec.ts")) {
    return false;
  }
  if (file.endsWith(".test.tsx") || file.endsWith(".spec.tsx")) {
    return false;
  }
  return file.endsWith(".ts") || file.endsWith(".tsx");
}

function toPosix(relPath) {
  return relPath.split(path.sep).join("/");
}

function toRoutePath(relative) {
  const ext = path.extname(relative);
  const base = relative.slice(0, -ext.length);
  if (base === "index") {
    return "/";
  }
  return `/${base}`;
}

function toImportPath(relative) {
  const ext = path.extname(relative);
  const base = relative.slice(0, -ext.length);
  return `../pages/api/v2/${base}`;
}

function main() {
  if (!fs.existsSync(apiRoot)) {
    throw new Error(`api root not found: ${apiRoot}`);
  }
  const files = collectFiles(apiRoot)
    .filter(isApiFile)
    .map((file) => toPosix(path.relative(apiRoot, file)))
    .sort();

  let counter = 0;
  const imports = [];
  const entries = [];

  for (const relative of files) {
    const importPath = toImportPath(relative);
    const routePath = toRoutePath(relative);
    const varName = `handler${counter}`;
    imports.push(`import ${varName} from "${importPath}";`);
    entries.push(`  { path: "${routePath}", handler: ${varName} },`);
    counter += 1;
  }

  const content = `/* eslint-disable */\n` +
    `// This file is auto-generated by scripts/generate-api-v2-manifest.js.\n` +
    `// Do not edit manually.\n\n` +
    `import type { Request, Response } from "express";\n` +
    `${imports.join("\n")}\n\n` +
    `export type ApiV2Handler = (req: Request, res: Response) => any;\n\n` +
    `export type ApiV2ManifestEntry = { path: string; handler: ApiV2Handler };\n\n` +
    `export const apiV2Manifest: ApiV2ManifestEntry[] = [\n` +
    `${entries.join("\n")}\n` +
    `];\n`;

  fs.mkdirSync(path.dirname(outFile), { recursive: true });
  fs.writeFileSync(outFile, content);
  console.log(`api v2 manifest written to ${outFile}`);
}

main();
